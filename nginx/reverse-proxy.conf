# nginx/reverse-proxy.conf
proxy_http_version 1.1;
proxy_set_header Connection "";
proxy_read_timeout 15s;
proxy_send_timeout 15s;
client_max_body_size 4m;

# very simple cache to show effect on GETs
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=apicache:10m max_size=50m inactive=60s use_temp_path=off;

# log lines include the X-Request-ID header for tracing
log_format with_reqid '$remote_addr - $remote_user [$time_local] '
                      '"$request" $status $body_bytes_sent '
                      '"$http_referer" "$http_user_agent" '
                      'req_id="$http_x_request_id" upstream="$upstream_addr" '
                      'rt="$request_time" urt="$upstream_response_time"';
                    
access_log /var/log/nginx/access.log with_reqid;

server {
  listen 8000;

  # Health for HAProxy checks
  location /health { 
    return 200 "OK";
  }

  # Cached GETs under /client/cache/*
  location ^~ /client/cache/ {
    proxy_cache apicache;
    proxy_cache_valid 200 10s;   # keep success for 10 seconds
    add_header X-Cache $upstream_cache_status;
    proxy_pass http://client-svc:5001/;
  }

  # Normal client routes
  location /client/ {
    proxy_set_header Host $host;
    proxy_pass http://client-svc:5001/;
  }

  # Account routes (contains /slow and /error to test behavior)
  location /account/ {
    proxy_set_header Host $host;
    proxy_next_upstream error timeout http_502 http_503;
    proxy_next_upstream_tries 1;
    proxy_pass http://account-svc:5002/;
  }
}
